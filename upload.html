<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Upload File</title>
  <style>
    :root { --bg:#18182a; --card:#23234a; --accent:#c46fad; --muted:#bbb; --btn:#6a3960; }
    body { font-family: Arial, Helvetica, sans-serif; background:var(--bg); color:#fff; margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center; padding:24px; }
    .card { background:var(--card); border-radius:12px; padding:28px; width:100%; max-width:520px; box-shadow:0 8px 30px rgba(0,0,0,0.4); text-align:center; }
    h1 { margin:0 0 12px 0; color:var(--accent); text-shadow:0 0 6px rgba(196,111,173,0.2); }
    #dropArea { border:2px dashed rgba(255,255,255,0.06); padding:28px; border-radius:10px; cursor:pointer; }
    #dropArea.drag { background: rgba(196,111,173,0.03); border-color: rgba(196,111,173,0.3); box-shadow:0 0 10px rgba(196,111,173,0.06); }
    .muted { color:var(--muted); font-size:14px; margin-top:8px; }
    input[type=file] { display:none; }
    .btn { background:var(--btn); color:#fff; border:none; padding:8px 14px; border-radius:8px; cursor:pointer; margin-top:12px; }
    .btn:hover { background:var(--accent); }
    #progressWrap { margin-top:16px; display:none; }
    #progressBar { width:100%; background:#111; height:12px; border-radius:8px; overflow:hidden; }
    #progressInner { width:0%; height:100%; background:linear-gradient(90deg,#6a3960,#c46fad); }
    #progressText { margin-top:8px; font-size:13px; color:var(--muted); }
    #link { margin-top:14px; color:var(--accent); word-break:break-all; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Upload Files</h1>
    <div id="dropArea">
      <p id="dropText">Drag & drop a file here â€” or <button id="pickBtn" class="btn" type="button">Choose a file</button></p>
      <p class="muted">Images & videos will be previewable in browser. After upload you'll get a link and a preview link for Discord embedding.</p>
      <input id="fileInput" type="file" name="file" />
    </div>

    <div id="progressWrap">
      <div id="progressBar"><div id="progressInner"></div></div>
      <div id="progressText">0 / 0 bytes</div>
    </div>

    <div id="link"></div>
  </div>

  <script>
    const dropArea = document.getElementById('dropArea');
    const fileInput = document.getElementById('fileInput');
    const pickBtn = document.getElementById('pickBtn');
    const progressWrap = document.getElementById('progressWrap');
    const progressInner = document.getElementById('progressInner');
    const progressText = document.getElementById('progressText');
    const linkDiv = document.getElementById('link');

    pickBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', () => {
      if (fileInput.files && fileInput.files[0]) uploadFile(fileInput.files[0]);
    });

    ;['dragenter','dragover'].forEach(ev => {
      dropArea.addEventListener(ev, (e) => {
        e.preventDefault(); e.stopPropagation();
        dropArea.classList.add('drag');
      });
    });
    ;['dragleave','drop'].forEach(ev => {
      dropArea.addEventListener(ev, (e) => {
        e.preventDefault(); e.stopPropagation();
        dropArea.classList.remove('drag');
      });
    });
    dropArea.addEventListener('drop', (e) => {
      const f = (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0]);
      if (f) uploadFile(f);
    });
    dropArea.addEventListener('click', () => fileInput.click());

    function humanBytes(n) {
      if (n < 1024) return n + ' B';
      if (n < 1024*1024) return (n/1024).toFixed(1) + ' KB';
      if (n < 1024*1024*1024) return (n/(1024*1024)).toFixed(1) + ' MB';
      return (n/(1024*1024*1024)).toFixed(2) + ' GB';
    }

    async function uploadFile(file) {
      linkDiv.textContent = '';
      progressWrap.style.display = 'block';
      progressInner.style.width = '0%';
      progressText.textContent = `0 / ${humanBytes(file.size)}`;

      const form = new FormData();
      form.append('file', file);

      // Use XHR to get upload progress
      const xhr = new XMLHttpRequest();
      xhr.open('POST', '/api/upload', true);
      xhr.withCredentials = true;

      xhr.upload.onprogress = (e) => {
        if (e.lengthComputable) {
          const percent = (e.loaded / e.total) * 100;
          progressInner.style.width = percent + '%';
          progressText.textContent = `${humanBytes(e.loaded)} / ${humanBytes(e.total)} (${Math.round(percent)}%)`;
        } else {
          progressText.textContent = `${humanBytes(e.loaded)} / ${humanBytes(file.size)}`;
        }
      };

      xhr.onload = () => {
        if (xhr.status >= 200 && xhr.status < 300) {
          try {
            const res = JSON.parse(xhr.responseText);
            if (res.success) {
              // Show both raw file link and preview page for Discord
              const raw = `${location.origin}${res.url}`;
              const preview = `${location.origin}${res.previewUrl}`;
              linkDiv.innerHTML = `
                File uploaded!<br>
                Raw link: <a href="${raw}" target="_blank">${raw}</a><br>
                Preview (for Discord embed): <a href="${preview}" target="_blank">${preview}</a>
              `;
            } else {
              linkDiv.textContent = 'Upload failed: ' + (res.error || 'unknown');
            }
          } catch (e) {
            linkDiv.textContent = 'Upload finished but response invalid.';
          }
        } else {
          linkDiv.textContent = 'Upload failed: ' + xhr.statusText;
        }
      };

      xhr.onerror = () => {
        linkDiv.textContent = 'Upload error.';
      };

      xhr.send(form);
    }
  </script>
</body>
</html>
